<div class="modal-listado-cliente-panel" *ngIf="mostrar">
  <div class="modal-header">
    <h2>Nuevo Pedido - Gestión de Cliente</h2>
    <button mat-icon-button (click)="cancelar()" class="btn-cerrar">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="modal-content">
    
    <!-- MODO BÚSQUEDA DE CLIENTES -->
    <div *ngIf="modoBusqueda && !clienteActual" class="modo-busqueda">
      <div class="busqueda-section">
        <h3>Buscar Cliente por Teléfono</h3>
        <mat-form-field appearance="outline" class="campo-full">
          <mat-label>Número de teléfono</mat-label>
          <input matInput 
                 (keyup)="buscarClientePorTelefono($event.target.value)" 
                 placeholder="Ej: 3001234567"
                 maxlength="10">
          <mat-icon matSuffix>search</mat-icon>
          <mat-hint>Ingrese 10 dígitos para buscar cliente</mat-hint>
        </mat-form-field>

        <!-- RESULTADO DE BÚSQUEDA -->
        <div class="resultado-busqueda">
          <div *ngIf="buscando" class="cargando">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Buscando cliente...</span>
          </div>

          <div *ngIf="!buscando && clienteEncontrado" class="cliente-encontrado">
            <div class="cliente-item" (click)="seleccionarCliente(clienteEncontrado)">
              <div class="cliente-info">
                <strong>{{ clienteEncontrado.nombre }}</strong>
                <span>{{ clienteEncontrado.celular }}</span>
                <small *ngIf="clienteEncontrado.direccion">{{ clienteEncontrado.direccion }}</small>
              </div>
              <mat-icon color="primary">check_circle</mat-icon>
            </div>
          </div>

          <div *ngIf="!buscando && telefonoIngresado && !clienteEncontrado" class="cliente-no-encontrado">
            <div class="sin-resultados">
              <mat-icon color="warn">person_off</mat-icon>
              <span>No se encontró cliente con este teléfono</span>
            </div>
          </div>
        </div>
      </div>

      <div class="separador">
        <span>O</span>
      </div>

      <div class="nuevo-cliente-section">
        <button mat-raised-button color="primary" (click)="nuevoCliente()" class="btn-nuevo">
          <mat-icon>person_add</mat-icon>
          Crear Nuevo Cliente
        </button>
      </div>
    </div>

    <!-- MODO FORMULARIO (Nuevo cliente o cliente seleccionado) - SE MANTIENE IGUAL -->
    <div *ngIf="mostrarFormulario" class="modo-formulario">
      
      <!-- Header del formulario -->
      <div class="form-header">
        <button mat-button (click)="volverABusqueda()" class="btn-volver">
          <mat-icon>arrow_back</mat-icon>
          Volver a búsqueda
        </button>

        <div *ngIf="clienteActual && !esEdicion" class="cliente-seleccionado-info">
          <span>Cliente seleccionado: <strong>{{ clienteActual.nombre }}</strong></span>
          <button mat-button (click)="editarCliente()" color="primary">
            <mat-icon>edit</mat-icon>
            Editar
          </button>
        </div>

        <div *ngIf="esEdicion" class="editando-info">
          <span>Editando cliente: <strong>{{ clienteActual?.nombre }}</strong></span>
          <button mat-button (click)="cancelarEdicion()" color="warn">
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
        </div>
      </div>

      <!-- Formulario - SE MANTIENE COMPLETAMENTE IGUAL -->
      <form [formGroup]="formulario" class="formulario">
        
        <!-- Campos base del cliente -->
        <mat-form-field appearance="outline" class="campo-full">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" placeholder="Nombre completo">
          <mat-error *ngIf="formulario.get('nombre')?.hasError('required')">
            El nombre es requerido
          </mat-error>
          <mat-error *ngIf="formulario.get('nombre')?.hasError('minlength')">
            El nombre debe tener al menos 2 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="campo-full">
          <mat-label>Teléfono</mat-label>
          <input matInput formControlName="celular" 
                 placeholder="Ej: 3001234567" maxlength="10">
          <mat-hint>10 dígitos sin espacios</mat-hint>
          <mat-error *ngIf="formulario.get('celular')?.hasError('required')">
            El teléfono es requerido
          </mat-error>
          <mat-error *ngIf="formulario.get('celular')?.hasError('pattern')">
            El teléfono debe tener 10 dígitos
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="campo-full">
          <mat-label>Dirección</mat-label>
          <textarea matInput formControlName="direccion" 
                    placeholder="Dirección completa" rows="3"></textarea>
        </mat-form-field>

        <!-- Campos adicionales para pedidos a domicilio -->
        <div *ngIf="mostrarCamposDomicilio" class="campos-pedido">
          <h4>Información de Domicilio</h4>
          
          <mat-form-field appearance="outline" class="campo-full">
            <mat-label>Repartidor</mat-label>
            <input matInput formControlName="repartidor" placeholder="Nombre del repartidor">
          </mat-form-field>

          <div class="campos-horizontales">
            <mat-form-field appearance="outline" class="campo-medio">
              <mat-label>Tiempo Estimado (min)</mat-label>
              <input matInput type="number" formControlName="tiempoEstimado" min="1" value="30">
              <mat-error *ngIf="formulario.get('tiempoEstimado')?.hasError('min')">
                El tiempo debe ser mayor a 0
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="campo-medio">
              <mat-label>Costo de Envío</mat-label>
              <input matInput type="number" formControlName="costoEnvio" min="0" step="0.01" value="0">
              <span matPrefix>$&nbsp;</span>
              <mat-error *ngIf="formulario.get('costoEnvio')?.hasError('min')">
                El costo no puede ser negativo
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Observaciones para todos los tipos de pedido -->
        <mat-form-field appearance="outline" class="campo-full">
          <mat-label>Observaciones del Pedido</mat-label>
          <textarea matInput formControlName="observacion" 
                    placeholder="Observaciones adicionales..." rows="2"></textarea>
        </mat-form-field>
      </form>
    </div>

  </div>

  <div class="modal-actions" *ngIf="mostrarFormulario">
    <button mat-button (click)="cancelar()">Cancelar</button>
    <button mat-raised-button color="primary" 
            (click)="guardarCliente()" 
            [disabled]="!formulario.valid || cargando">
      {{ textoBotonPrincipal }}
    </button>
  </div>
</div>